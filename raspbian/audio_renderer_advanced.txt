Audio Render Advanced

0. Flashing

	$ sudo fdisk -l
	$ sudo dd bs=4M if=2017-08-16-raspbian-stretch-lite.img of=/dev/sdc
	$ scp mpd mpd.conf hub-ctrl llctl icon.png audio-config kr2mpd ut2mpd tts *.pls pi@192.168.0.3:/home/pi/

	$ sudo raspi-config
		5 Interfacing Options > P2 SSH

	$ ssh pi@rpi_ip
	  password: raspberry

1. Update & upgrade

	sudo apt-get update
	sudo apt-get upgrade
	sudo apt-get dist-upgrade

	sudo apt-get install ntpdate bc exfat-fuse exfat-utils

2. Configuration file

	sudo nano /boot/config.txt
		#dtparam=audio=on
		gpu_mem=16
		disable_splash=1

	cat /proc/cpuinfo
	cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq

3. Kernel option

	sudo nano /boot/cmdline.txt
		root=
		#console=serial0,115200 console=tty1
		consoleblank=0
		smsc95xx.turbo_mode=0
		elevator=noop
		selinux=0
		#dwc_otg.fiq_split_enable=0 dwc_otg.fiq_fix_enable=0
		#dwc_otg.fiq_fsm_enable=0
		#dwc_otg.fiq_enable=1 dwc_otg.fiq_fsm_enable=1 dwc_otg.fiq_fsm_mask=0x3

4. Localisation

	sudo dpkg-reconfigure locales
	sudo dpkg-reconfigure tzdata
	
5. Disable modules

	lsmod
	sudo nano /etc/modprobe.d/raspi-blacklist.conf
		blacklist uio
		blacklist uio-pdrv-genirq
		#blacklist cfg80211
		#blacklist bcm2835_gpiomem
		#blacklist fixed
		#blacklist ip_tables
		###Disable RPi3 Wi-Fi
		#blacklist brcmfmac
		#blacklist brcmutil
		###Disable RPi3 Bluetooth
		#blacklist btbcm
		#blacklist hci_uart

6. ALSA configuration
	sudo nano /lib/modprobe.d/aliases.conf
		#options snd-usb-audio index=-2

7. MPD Setup

	sudo apt-get install libcue1 libaudiofile1 libavformat57 libflac8 libmad0 libid3tag0 libmpdclient2 libmms0 libupnp6
	sudo mkdir -p /var/lib/mpd/music /var/lib/mpd/playlists /run/mpd
	sudo cp mpd /usr/bin/
	sudo cp mpd.conf /etc/mpd.conf.sav
	sudo apt-get install mpc ncmpc

8. Upmpdcli Setup

9. CIFS & NFS mounting

	sudo apt-get install cifs-utils nfs-common
	sudo mkdir /mnt/cifs /mnt/nfs
	sudo ln -s /mnt/     /var/lib/mpd/music
	sudo nano /etc/fstab
		#//192.168.0.x/xxx /mnt/cifs cifs guest,ro,rsize=8192,iocharset=utf8 0 0
		#192.168.0.x:/xxx  /mnt/nfs  nfs  ro,sync,hard,intr,rsize=8192,iocharset=utf8 0 0

10. Edit /etc/fstab

	/dev/mmcblk0p1  /boot           vfat    defaults          0       2
	/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1

11. Edit /etc/rc.local
	
12. Sysctl Configuration

	sudo nano /etc/sysctl.conf

13. Disabel swap

	cat /proc/swaps
	sudo systemctl disable dphys-swapfile

14. USB Mount

	https://wiki.archlinux.org/index.php/Fstab#External_devices

	sudo nano /etc/fstab
		 /dev/sda1 /mnt/usb auto defaults,nofail,x-systemd.device-timeout=1,ro 0 2
		#/dev/sda1 /mnt/usb vfat    ro 0 0
		#/dev/sda1 /mnt/usb ntfs-3g ro 0 0
	sudo nano /etc/rc.local
		systemd-udevd
	sudo systemctl daemon-reload
	sudo systemctl restart remote-fs.target
	sudo systemctl restart local-fs.target

15. Internet Radio & TTS (Text to Speech)

	sudo curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl
	sudo chmod a+rx /usr/local/bin/youtube-dl
	sudo ln -s /home/pi/kr2mpd /home/pi/ut2mpd /home/pi/tts /usr/bin/
	sudo nano /var/lib/mpd/playlists/internet\ radio.m3u
	sudo mkdir /var/lib/mpd/music/webradio
	sudo mv *.pls /var/lib/mpd/music/webradio
	mpc update

16. Spotifyd

	https://github.com/Spotifyd/spotifyd
	https://github.com/Spotifyd/spotifyd/releases/latest

	wget https://github.com/Spotifyd/spotifyd/releases/download/untagged-4cc466d87efba3c28f5a/spotifyd-2018-05-26-armv6.zip
	unzip spotifyd-*.zip -d /home/pi
	sudo nano /etc/rc.local

	spotifyd () {
	cp /usr/lib/arm-linux-gnueabihf/libasound.so.2.0.0_old /dev/shm/libasound.so.2.0.0
	cp /home/pi/spotifyd /home/pi/spotifyd.conf /dev/shm/
	sleep 1
	/dev/shm/spotifyd --no-daemon -c /dev/shm/spotifyd.conf&> /dev/null
	}
	...
	#spotifyd &

	nano /home/pi/spotifyd.conf

	[global]
	username = USER
	password = PASS
	backend = alsa
	device = pcm.0
	device_name = Spotifyd
	#bitrate = 320

	nano audio-config

	sudo sed -i '/spotifyd &/s/^#*//' /etc/rc.local
	sudo sed -i '/spotifyd &/s/^/#/'  /etc/rc.local
	sed -i '/username/s/=.*/= 사용자/; /password/s/=.*/= 비밀번호/' /home/pi/spotifyd.conf

17. Roon Bridge

	https://kb.roonlabs.com/LinuxInstall

	# default - Default PCM device (?)

	$ sudo ntpdate pool.ntp.org
	$ sudo apt update
	$ sudo apt upgrade
	$ sudo apt dist-upgrade

	$ curl -O http://download.roonlabs.com/builds/roonbridge-installer-linuxarmv7hf.sh
	$ chmod +x roonbridge-installer-linuxarmv7hf.sh
	$ sudo ./roonbridge-installer-linuxarmv7hf.sh

	$ sudo nano /etc/systemd/system/roonbridge.service
		ExecStart=/opt/RoonBridge/Bridge/RoonBridge
	$ sudo systemctl daemon-reload
	$ sudo systemctl disable roonbridge

	$ sudo sh -c "cat /usr/share/alsa/alsa.conf.sav > /usr/share/alsa/alsa.conf.roon"
	$ sudo sh -c "printf '\n' >> /usr/share/alsa/alsa.conf.roon"
	$ sudo sh -c "cat /usr/share/alsa.org/alsa.conf >> /usr/share/alsa/alsa.conf.roon"
	$ sudo sed -i 's/^[ \t]*//; /^$/d' /usr/share/alsa/alsa.conf.roon
	$ head -20 /usr/share/alsa/alsa.conf.roon
	$ sudo nano /usr/share/alsa/alsa.conf.roon

	$ sudo nano /etc/rc.local

	roon_bridge () {
	 cp /usr/share/alsa/alsa.conf.roon /dev/shm/alsa.conf
	 cp /usr/lib/arm-linux-gnueabihf/libasound.so.2.0.0_old /dev/shm/libasound.so.2.0.0
	 sleep 1
	 systemctl start roonbridge
	}
	...
	### Roon Bridge
	#(roon_bridge &) && sleep 3

	$ nano ~/audio-config

	sudo sed -i '/roon_bridge &/s/^#*//' /etc/rc.local
	sudo sed -i '/roon_bridge &/s/^/#/' /etc/rc.local

18. Shairport-sync (AirPlay)

	$ sudo apt update
	$ sudo apt install shairport-sync
	$ sudo sed -i '/_device =/s/^\/*//; /output_device =/s/".*";/"pcm.0";/; /mixer_device =/s/".*";/"\/dev\/null";/' /etc/shairport-sync.conf
	$ sudo sed -i '/_format =/s/^\/*//; /output_format =/s/".*";/"S24";/' /etc/shairport-sync.conf   # 24Bit Only
	$ sudo sed -i '/interpolation =/s/^\/*//; /interpolation =/s/".*";/"soxr";/' /etc/shairport-sync.conf   # 24Bit Only
	$ sudo systemctl disable avahi-daemon shairport-sync
	$ sudo nano /etc/rc.local

	#service avahi-daemon stop
	shairport_sync () {
	 cp /usr/lib/arm-linux-gnueabihf/libasound.so.2.0.0_old /dev/shm/libasound.so.2.0.0
	 sleep 1
	 systemctl start avahi-daemon shairport-sync
	}
	...
	### Shaiport-sync
	#(shairport_sync &) && sleep 3

	$ nano ~/audio-config

18. audio-config

	cp audio-config /home/pi
	sudo ln -s /home/pi/audio-config /usr/bin/
	audio-config

19. Read-only
	cp remountro remountrw /home/pi
	chmod +x remountro remountrw
	sudo ln -s /home/pi/remountro /home/pi/remountrw /usr/bin/
	sudo nano /etc/rc.local
		### Read-only
		#remountro
	sudo chmod -w /lib/systemd/systemd /etc/rc.local /usr/lib/arm-linux-gnueabihf/libasound.so.2.0.0.sav /usr/lib/arm-linux-gnueabihf/libasound.so.2.0.0.sav /usr/bin/mpd /etc/mpd.conf.sav /usr/bin/upmpdcli /etc/upmpdcli.conf
	sudo chmod -R -w /usr/lib/arm-linux-gnueabihf

20. Make Image

	$ echo "* Mino's UPnP Audio Renderer for Raspberry Pi 18.05" > ~/release
	$ mpc clear
	$ sudo rm -rf /var/roon/*
	$ sudo rm -f /root/.bash_history ~/.bash_history ; history -c
	$ sudo poweroff

	$ sudo fdisk -l
	$ sudo dd bs=4M if=/dev/sdc of=raspbian_audio_renderer_18.07.img
	$ zip raspbian_audio_renderer_18.07.zip raspbian_audio_renderer_18.07.img
