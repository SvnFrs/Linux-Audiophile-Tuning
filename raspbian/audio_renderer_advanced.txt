Audio Render Advanced

0. Flashing

	$ sudo fdisk -l
	$ sudo dd bs=4M if=2016-09-23-raspbian-jessie-lite.img of=/dev/sdb
	$ sudo gparted
	$ copy mpd hub-ctrl llctl icon.png /home/pi
	$ ssh pi@rpi_ip
	  password: raspberry

1. Update & upgrade

	sudo apt-get update
	sudo apt-get upgrade
	sudo apt-get dist-upgrade

2. Configuration file

	sudo nano /boot/config.txt
		#dtparam=audio=on

		gpu_mem=16
		disable_splash=1
		disable_pvt=1

	cat /proc/cpuinfo
	cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq

3. Kernel option

	sudo nano /boot/cmdline.txt
		#console=serial0,115200 console=tty1
		consoleblank=0
		smsc95xx.turbo_mode=0
		elevator=noop
		selinux=0
		#dwc_otg.fiq_split_enable=0 dwc_otg.fiq_fix_enable=0
		#dwc_otg.fiq_fsm_enable=0
		dwc_otg.fiq_enable=1 dwc_otg.fiq_fsm_enable=1 dwc_otg.fiq_fsm_mask=0x3

4. Localisation

	#sudo dpkg-reconfigure locales
	 sudo dpkg-reconfigure tzdata
	
5. Disable modules

	lsmod
	sudo nano /etc/modprobe.d/raspi-blacklist.conf
		blacklist uio
		blacklist uio-pdrv-genirq
		###Disable RPi3 Wi-Fi
		#blacklist brcmfmac
		#blacklist brcmutil
		###Disable RPi3 Bluetooth
		#blacklist btbcm
		#blacklist hci_uart

6. ALSA configuration
	sudo nano /lib/modprobe.d/aliases.conf
		#options snd-usb-audio index=-2

7. MPD install & recompile

	sudo apt-get install mpd mpc ncmpc
	
8. MPD Settings

	sudo mv /usr/bin/mpd /usr/bin/mpd.org
	sudo cp ~/mpd.0.19.19.ffmpeg /usr/bin/mpd
	sudo nano /etc/mpd.conf
	sudo nano /lib/systemd/system/mpd.service
	sudo nano /etc/default/mpd
	sudo systemctl disable mpd.service mpd.socket
	sudo systemctl daemon-reload

9. Upmpdcli Setup

10. Polipo Setup

11. CIFS & NFS mounting

	sudo apt-get install cifs-utils nfs-common
	sudo mkdir /mnt/cifs /mnt/nfs
	sudo ln -s /mnt/     /var/lib/mpd/music
	sudo nano /etc/fstab
		#//192.168.0.x/xxx /mnt/cifs cifs guest,ro,rsize=8192,iocharset=utf8 0 0
		#192.168.0.x:/xxx  /mnt/nfs  nfs  ro,sync,hard,intr,rsize=8192,iocharset=utf8 0 0
		
12. Ramdisk (Just for reference)

	sudo nano /etc/fstab

		#...swap...
		 ramfs /tmp       tmpfs nosuid,nodev,noatime,nodiratime 0 0
		#tmpfs /var/cache tmpfs nosuid,nodev,noatime,nodiratime 0 0
		 ramfs /var/log   tmpfs nosuid,nodev,noatime,nodiratime 0 0

	or

	rm -rf /var/cache && mkdir -p /run/var/cache && ln -s /run/var/cache /var
	rm -rf /var/log   && mkdir -p /run/var/log   && ln -s /run/var/log   /var
	rm -rf /tmp       && mkdir -p /run/tmp       && ln -s /run/tmp       /
	sudo nano /etc/fstab
			#ramfs /tmp       tmpfs nosuid,nodev,noatime,nodiratime 0 0
			#tmpfs /var/cache tmpfs nosuid,nodev,noatime,nodiratime 0 0
			#ramfs /var/log   tmpfs nosuid,nodev,noatime,nodiratime 0 0
	sudo nano /etc/rc.local
		mkdir -p /run/var/cache /run/var/log /run/tmp

13. Edit /etc/rc.local
	
14. Sysctl Configuration

	sudo nano /etc/sysctl.conf

15. Disabel swap

	sudo systemctl disable dphys-swapfile

16. USB Mount

	https://wiki.archlinux.org/index.php/Fstab#External_devices

	sudo nano /etc/fstab
		 /dev/sda1 /mnt/usb auto defaults,nofail,x-systemd.device-timeout=1,ro 0 2
		#/dev/sda1 /mnt/usb vfat    ro 0 0
		#/dev/sda1 /mnt/usb ntfs-3g ro 0 0
	sudo nano /etc/rc.local
		systemd-udevd
	sudo systemctl daemon-reload
	sudo systemctl restart remote-fs.target
	sudo systemctl restart local-fs.target

17. Internet Radio

	sudo apt-get install mplayer2
	nano ~/.mplayer/config
		ao=alsa:device=sound
	cp kradio ~
	sudo ln -s /home/pi/kradio /usr/bin/

	sudo nano /var/lib/mpd/playlists/Internet_Radios.m3u
		http://sc-classical.1.fm:8047#1.fm Otto's Classical Music
		http://8.38.78.173:8045/#Audiophile Baroque
		http://8.38.78.173:8093/#Audiophile Classical
		http://89.16.185.174:8004/stream#Linn Classical
		#http://37.130.228.60:8090/#Naim Radio
		http://stream.iradio.fi:8000/klasu-hi.mp3#Rondo Classic - Klasu

18. audio-config

	cp audio-config /home/pi
	sudo ln -s /home/pi/audio-config /usr/bin/
	audio-config

19. Show release

	$ echo "* Mino's UPnP Audio Renderer for Raspberry Pi 17.04" > release

20. Make Image

	$ nano ~/release
	$ mpc clear
	$ sudo sed -i '/chunkHighMark/d' /etc/polipo/config
	$ cat /etc/polipo/config
	$ sudo rm -f /root/.bash_history ~/.bash_history ; history -c
	$ sudo poweroff

	$ sudo fdisk -l
	$ sudo dd bs=4M if=/dev/sdb of=raspbian_audio_renderer_17.05.img
	$ zip raspbian_audio_renderer_17.05.zip raspbian_audio_renderer_17.05.img
