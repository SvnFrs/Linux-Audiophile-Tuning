Raspbian Jessie Lite

0. Flashing

	$ sudo fdisk -l
	$ sudo dd bs=4M if=2016-02-09-raspbian-jessie-lite.img of=/dev/sdb
	$ sudo gparted
	$ copy mpd.0.19.18.ffmpeg hub-ctrl llctl icon.png /home/pi
	$ ssh pi@rpi_ip
	  pi@rpi_ip's password: raspberry

1. Configuration file

	sudo nano /boot/config.txt
		gpu_mem=16
		disable_splash=1
		disable_pvt=1
		#dtoverlay=...
		#dtparam=audio=on
	cat /proc/cpuinfo
	cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq

2. Kernel option

	sudo nano /boot/cmdline.txt
		dwc_otg.fiq_split_enable=0 (?)
		consoleblank=0
		#console=serial0,115200 console=tty1
		smsc95xx.turbo_mode=0
		elevator=noop
		selinux=0
		#dwc_otg.fiq_split_enable=0 dwc_otg.fiq_fix_enable=0
		dwc_otg.fiq_enable=1 dwc_otg.fiq_fsm_enable=1 dwc_otg.fiq_fsm_mask=0x3
		#dwc_otg.fiq_fsm_enable=0

3. Update & upgrade

	sudo apt-get update
	sudo apt-get upgrade
	sudo apt-get dist-upgrade
	#sudo apt-get install rpi-update
	#sudo rpi-update
	#sudo reboot

4. Localisation

	sudo dpkg-reconfigure locales
	sudo dpkg-reconfigure tzdata
	
5. Disable modules

	lsmod
	nano /etc/modprobe.d/raspi-blacklist.conf
		blacklist uio
		blacklist uio-pdrv-genirq

6. Disable services

	systemctl disable ...
	
7. ALSA configuration

	sudo mv /usr/share/alsa/alsa.conf /usr/share/alsa/alsa.conf.org
	sudo nano /usr/share/alsa/alsa.conf
		pcm.sound.card   1
		ctl.control.card 1
		#pcm.default pcm.sound
	sudo systemctl mask alsa-store.service
	sudo systemctl mask alsa-restore.service

8. MPD install & recompile

	sudo apt-get install mpd mpc ncmpc
	
9. MPD Settings

	sudo mv /usr/bin/mpd /usr/bin/mpd.org
	sudo cp ~/mpd.0.19.18.ffmpeg /usr/bin/mpd
	sudo nano /etc/mpd.conf
	sudo nano /lib/systemd/system/mpd.service
	sudo nano /etc/default/mpd
	sudo systemctl restart mpd
		
10. Upmpdcli Setup

11. CIFS & NFS mounting

	sudo apt-get install cifs-utils nfs-common
	sudo mkdir /mnt/cifs /mnt/nfs
	sudo ln -s /mnt/     /var/lib/mpd/music
	sudo nano /etc/fstab
		#//192.168.0.x/xxx /mnt/cifs cifs guest,ro,rsize=8192,iocharset=utf8 0 0
		#192.168.0.x:/xxx  /mnt/nfs  nfs  ro,sync,hard,intr,rsize=8192,iocharset=utf8 0 0
		
12. Tmpfs

	nano /etc/fstab
		tmpfs /tmp       tmpfs nosuid,nodev,noatime,nodiratime 0 0
		tmpfs /var/cache tmpfs nosuid,nodev,noatime,nodiratime 0 0
		tmpfs /var/log tmpfs nosuid,nodev,noatime,nodiratime 0 0

13. Edit /etc/rc.local
	
14. Sysctl Configuration

	sudo nano /etc/sysctl.conf
		#debug.exception-trace = 0
		#kernel.watchdog = 0
		#kernel.sched_rt_runtime_us = -1
		#kernel.sched_rt_period_us = 42700
		# kernel.printk = 4 4 1 4
		#vm.swappiness = 0
		# vm.overcommit_memory = 1
		#vm.overcommit_ratio = 0
		# vm.dirty_writeback_centisecs = 0
		# vm.oom_dump_tasks = 0
		# vm.oom_kill_allocating_task = 1
		# vm.panic_on_oom = 2
		# vm.stat_interval = 3
		#vm.user_reserve_kbytes = 0

		net.core.rmem_max = 12582912
		net.core.wmem_max = 12582912
		#net.ipv4.conf.default.forwarding = 1
		net.ipv4.tcp_rmem = 10240 87380 12582912
		net.ipv4.tcp_wmem = 10240 87380 12582912
		net.ipv4.tcp_timestamps = 0
		#net.ipv4.tcp_window_scaling = 1
		net.ipv4.tcp_sack = 0
		net.ipv4.tcp_no_metrics_save = 1
		net.core.netdev_max_backlog = 5000
		#net.ipv6.conf.all.disable_ipv6 = 1

	sudo reboot
	cat /proc/sys/net/ipv4/tcp_sack /proc/sys/net/ipv4/tcp_no_metrics_save /proc/sys/net/core/netdev_max_backlog

15. Ramlog
	mount | grep log
	sudo nano /etc/fstab
		tmpfs /var/log tmpfs nosuid,nodev,noatime,nodiratime 0 0
	sudo nano /etc/mpd.conf
		#log_file   "/var/log/mpd/mpd.log"

16. USB Mount

	sudo apt-get install usbmount
	sudo nano /etc/usbmount/usbmount.conf
		MOUNTPOINTS="/mnt/usb0-7"
	sudo reboot
	
17. AirPlay

	https://github.com/mikebrady/shairport-sync
	
	sudo apt-get install shairport-sync
		wget http://archive.raspbian.org/raspbian/pool/main/s/shairport-sync/shairport-sync_2.8.1-1_armhf.deb
		wget http://archive.raspbian.org/raspbian/pool/main/o/openssl/libssl1.0.2_1.0.2g-1_armhf.deb
		sudo apt-get install libconfig9
		sudo dpkg -i shairport-sync*.deb libssl1.0.2*.deb
	sudo systemctl disable shairport-sync
	sudo nano /etc/shairport-sync.conf
		general =
		{
		interpolation = "soxr"
		ignore_volume_control = "yes"
		};
		sessioncontrol =
		{
		run_this_before_play_begins = "mpc stop"
		};
		alsa =
		{
		output_device = "sound"
		//  mixer_device = "default"
		};
	nano ~/airplay
	#!/bin/sh
	if [ "$(nproc --all)" = "4" ]
	 then
	  taskset -c 3 shairport-sync
	 else
	  shairport-sync
	fi
	chmod +x ~/airplay
	sudo ln -s /home/pi/airplay /usr/bin/
	airplay

	https://github.com/juhovh/shairplay
	
	sudo apt-get install shairplay
	shairplay -h
	cp /etc/shairplay/airport.key /home/pi/
	shairplay --ao_driver=alsa --ao_devicename=sound
	nano ~/airplay
		#!/bin/sh
		shairplay --ao_driver=alsa --ao_devicename=sound
	chmod +x ~/airplay
	sudo ln -s /home/pi/airplay /usr/bin/
	airplay
	sudo nano /etc/rc.local
	#cd /etc/shairport
	#shairplay --ao_driver=alsa --ao_devicename=sound >/dev/null 2>&1 &
	#cd

18. Internet Radio

	sudo apt-get install mplayer2
	mkdir ~/.mplayer
	nano ~/.mplayer/config
		ao=alsa:device=sound
		#mixer=default
		softvol=no
		#cache=192
		#vc=null
		#vo=null
	nano ~/kbs1fm
		#!/bin/sh
		mpc stop
		mplayer --novideo --cache=192 http://juoradio.appspot.com/kbs1 >/dev/null 2>&1 &
		if [ "$(nproc --all)" = "4" ]; then
		 sleep 3
		 opg_mplayer=$(pgrep -o mplayer)
		 taskset -pc 2 $opg_mplayer
		 chrt -v -ip 0 $opg_mplayer
		 renice  19 -p $opg_mplayer
		 ionice -c3 -p $opg_mplayer
		 taskset -pc 3 $(pgrep -n mplayer)
		fi
	nano ~/kbs2fm
		#!/bin/sh
		mpc stop
		mplayer --novideo --cache=192 http://juoradio.appspot.com/kbs2 >/dev/null 2>&1 &
		if [ "$(nproc --all)" = "4" ]; then
		 sleep 3
		 opg_mplayer=$(pgrep -o mplayer)
		 taskset -pc 2 $opg_mplayer
		 chrt -v -ip 0 $opg_mplayer
		 renice  19 -p $opg_mplayer
		 ionice -c3 -p $opg_mplayer
		 taskset -pc 3 $(pgrep -n mplayer)
		fi
	nano ~/kbs2radio
		#!/bin/sh
		mpc stop
		mplayer --novideo --cache=192 http://juoradio.appspot.com/kbs2r >/dev/null 2>&1 &
		if [ "$(nproc --all)" = "4" ]; then
		 sleep 3
		 opg_mplayer=$(pgrep -o mplayer)
		 taskset -pc 2 $opg_mplayer
		 chrt -v -ip 0 $opg_mplayer
		 renice  19 -p $opg_mplayer
		 ionice -c3 -p $opg_mplayer
		 taskset -pc 3 $(pgrep -n mplayer)
		fi
	nano ~/cbsfm
		#!/bin/sh
		mpc stop
		mplayer --novideo --cache=192 rtmp://aac.cbs.co.kr/cbs939/_definst_/cbs939.stream >/dev/null 2>&1 &
		if [ "$(nproc --all)" = "4" ]; then
		 sleep 3
		 opg_mplayer=$(pgrep -o mplayer)
		 taskset -pc 2 $opg_mplayer
		 chrt -v -ip 0 $opg_mplayer
		 renice  19 -p $opg_mplayer
		 ionice -c3 -p $opg_mplayer
		 taskset -pc 3 $(pgrep -n mplayer)
		fi
	chmod +x ~/kbs1fm ~/kbs2fm ~/cbsfm
	sudo ln -s /home/pi/kbs1fm /home/pi/kbs2fm /home/pi/kbs2radio /home/pi/cbsfm /usr/bin/
	kbs1fm
	kbs2fm
	kbs2radio
	cbsfm
	sudo nano /var/lib/mpd/playlists/Internet_Radios.m3u
		http://sc-classical.1.fm:8047#1.fm Otto's Classical Music
		http://50.7.173.162:8010/#Audiophile Baroque
		http://50.7.173.162:8012/#Audiophile Classical
		http://89.16.185.174:8004/stream#Linn Classical
		http://37.130.228.60:8090/#Naim Radio
		http://stream.iradio.fi:8000/klasu-hi.mp3#Rondo Classic - Klasu

19. Show release

	$ echo "* Mino's UPnP Audio Renderer for Raspberry Pi v.0.9.9 basic" > release
	$ sudo nano /etc/rc.local
		cat /home/pi/release

20. Make Image

	$ nano ~/release
	$ mpc clear
	$ history -c ; rm ~/.bash_history
	$ sudo poweroff
	$ Remove /home/pi/.bash_history
	$ sudo fdisk -l
	$ sudo dd bs=4M count=500 if=/dev/sdb of=raspbian_audio_renderer_basic_v.0.9.9.img
	$ zip raspbian_audio_renderer_basic_v.0.9.9.zip raspbian_audio_renderer_basic_v.0.9.9.img
