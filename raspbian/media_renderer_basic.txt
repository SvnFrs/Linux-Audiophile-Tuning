Raspbian Jessie Lite

0. Flashing

	$ sudo fdisk -l
	$ sudo dd bs=4M if=2016-02-09-raspbian-jessie-lite.img of=/dev/sdb
	$ sudo gparted
	$ copy mpd.0.19.12.ffmpeg llctl icon.png /home/pi
	$ ssh pi@rpi_ip
	pi@rpi_ip's password: raspberry

1. Configuration file

	sudo nano /boot/config.txt
		gpu_mem=16
		disable_splash=1
		disable_pvt=1
		#dtoverlay=...
		#dtparam=audio=on
	cat /proc/cpuinfo
	cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq

2. Kernel option

	sudo nano /boot/cmdline.txt
		dwc_otg.fiq_split_enable=0 (?)
		consoleblank=0

3. Update & upgrade

	sudo apt-get update
	sudo apt-get upgrade
	sudo apt-get dist-upgrade
	#sudo apt-get install rpi-update
	#sudo rpi-update
	#sudo reboot

4. Localisation

	sudo dpkg-reconfigure locales
	sudo dpkg-reconfigure tzdata
	
5. Disable modules

	lsmod
	nano /etc/modprobe.d/raspi-blacklist.conf
		blacklist uio
		blacklist uio-pdrv-genirq

6. Disable services

	systemctl disable ...
	
7. ALSA configuration

	sudo mv /usr/share/alsa/alsa.conf /usr/share/alsa/alsa.conf.org
	sudo nano /usr/share/alsa/alsa.conf
		pcm.sound.card 1
		ctl.sound.card 1
	sudo systemctl mask alsa-store.service
	sudo systemctl mask alsa-restore.service

8. MPD install & recompile

	sudo apt-get install mpd mpc ncmpc
	
9. MPD Settings

	sudo mv /usr/bin/mpd /usr/bin/mpd.org
	sudo cp ~/mpd.0.19.12.ffmpeg /usr/bin/mpd
	sudo nano /etc/mpd.conf
	sudo nano /lib/systemd/system/mpd.service
	sudo nano /etc/default/mpd
	sudo systemctl restart mpd
		
10. Upmpdcli Setup

11. CIFS & NFS mounting

	sudo apt-get install cifs-utils nfs-common
	sudo mkdir /mnt/cifs /mnt/nfs
	sudo ln -s /mnt/     /var/lib/mpd/music
	sudo nano /etc/fstab
		#//192.168.0.x/xxx /mnt/cifs cifs guest,ro,rsize=8192,iocharset=utf8 0 0
		#192.168.0.x:/xxx  /mnt/nfs  nfs  ro,sync,hard,intr,rsize=8192,iocharset=utf8 0 0
		
12. Tmpfs

	nano /etc/fstab
		tmpfs /tmp tmfs nosuid,nodev 0 0
		
13. Edit /etc/rc.local

	sleep 5

	MPD_PID=`pgrep -F /run/mpd/pid`
	#
	#MPD_PIDS=`chrt -ap "$MPD_PID" | awk 'NR %2 == 0 {printf "%i\n",$2}'`
	#
	##   MAIN_PID=`echo "$MPD_PIDS" | awk 'NR == 1 {print}'`
	#  UPDATE_PID=`echo "$MPD_PIDS" | awk 'NR == 2 {print}'`
	## PLAYER_PID=`echo "$MPD_PIDS" | awk 'NR == 3 {print}'`
	##DECODER_PID=`echo "$MPD_PIDS" | awk 'NR == 4 {print}'`
	## OUTPUT_PID=`echo "$MPD_PIDS" | awk 'NR == 5 {print}'`
	#
	chrt    -apo 0 "$MPD_PID"
	#taskset -apc 3 "$MPD_PID"	# RPi1&Zero:single-core, RPi2:quad-core
	#
	#ionice -c 3 -p "$UPDATE_PID"
	#renice -n 19   "$UPDATE_PID"
	#chrt   -ip 0   "$UPDATE_PID"
	
	### For Criterion from Reference Club
	#amixer -D ctl.sound set 'XMOS Clock Selector',0 Capture 0 0 off off || /bin/true
	#amixer -D ctl.sound set 'XMOS Clock Selector',1 Capture 0 off     || /bin/true
	
	ifconfig eth0 txqueuelen 10000
	echo noop > /sys/block/mmcblk0/queue/scheduler
	
	### Turn off LEDs
	echo none > /sys/class/leds/led0/trigger
	echo 0    > /sys/class/leds/led0/brightness
	echo 0    > /sys/class/leds/led1/brightness
	/home/pi/llctl f0 l0 d0
	
14. Sysctl Configuration

	sudo nano /etc/sysctl.conf
		#debug.exception-trace = 0
		#kernel.watchdog = 0
		#kernel.sched_rt_runtime_us = -1
		#kernel.sched_rt_period_us = 42700
		kernel.printk = '4 4 1 4'
		#vm.swappiness = 0
		vm.overcommit_memory = 1
		vm.overcommit_ratio = 100
		vm.dirty_writeback_centisecs = 0
		vm.oom_dump_tasks = 0
		vm.oom_kill_allocating_task = 1
		vm.panic_on_oom = 2
		vm.stat_interval = 3
		vm.user_reserve_kbytes = 0

		net.core.rmem_max = 12582912
		net.core.wmem_max = 12582912
		#net.ipv4.conf.default.forwarding = 1
		net.ipv4.tcp_rmem = '10240 87380 12582912'
		net.ipv4.tcp_wmem = '10240 87380 12582912'
		net.ipv4.tcp_timestamps = 0
		#net.ipv4.tcp_window_scaling = 1
		net.ipv4.tcp_sack = 0
		net.ipv4.tcp_no_metrics_save = 1
		net.core.netdev_max_backlog = 5000
		#net.ipv6.conf.all.disable_ipv6 = 1

	sudo reboot
	cat /proc/sys/net/ipv4/tcp_sack /proc/sys/net/ipv4/tcp_no_metrics_save /proc/sys/net/core/netdev_max_backlog
	
15. Enable I2C
	sudo raspi-config
		8 Advanced Option > A7 I2C
	or
	sudo nano /etc/modules
		i2c-bcm2708 
		i2c-dev
	sudo nano /etc/modprobe.d/raspi-blacklist.conf
		#blacklist spi-bcm2708
		#blacklist i2c-bcm2708
	sudo nano /boot/config.txt
		dtparam=i2c1=on
		dtparam=i2c_arm=on
		
	sudo nano /boot/config.txt
		### HiFiBerry I2C
		#dtoverlay=hifiberry-amp
		#dtoverlay=hifiberry-dac
		#dtoverlay=hifiberry-dacplus
		#dtoverlay=hifiberry-digi
		### IQaudIO I2C
		#dtoverlay=iqaudio-dac
		#dtoverlay=iqaudio-dacplus
	sudo nano /etc/rc.local
		### Unmute IQaudIO I2C
		#echo "22" > /sys/class/gpio/export
		#echo "out" > /sys/class/gpio/gpio22/direction
		#echo "1" > /sys/class/gpio/gpio22/value
	sudo nano /etc/mpd.conf
		### Volume for I2C
		#mixer_type "hardware"
		#mixer_control "Digital"
		#mixer_device "sound"
	
16. USB Mount

	sudo apt-get install usbmount
	sudo nano /etc/usbmount/usbmount.conf
		MOUNTPOINTS="/mnt/usb0-7"
	sudo reboot
	
17. Shairplay (AirPlay)

	https://github.com/juhovh/shairplay
	
	sudo apt-get install shairplay
	cp /etc/shairplay/airport.key /home/pi/
	shairplay --ao_driver=alsa --ao_devicename=sound


	nano ~/airport
		#!/bin/sh
		shairplay --ao_driver=alsa --ao_devicename=sound
	chmod +x ~/kbs1fm ~/kbs2fm ~/cbsfm
	sudo ln -s /home/pi/airport /usr/bin/
	airport

	If it succeeds,
	sudo nano /etc/rc.local
	#cd /etc/shairport
	#shairplay --ao_driver=alsa --ao_devicename=sound >/dev/null 2>&1 &
	#cd

18. Internet Radio

	sudo apt-get install mplayer2
	mkdir ~/.mplayer
	nano ~/.mplayer/config
		ao=alsa:device=sound
		mixer=sound
		softvol=no
		cache=192
		vc=null
		vo=null
	nano ~/kbs1fm
		#!/bin/sh
		(taskset -c 3) mplayer http://juoradio.appspot.com/kbs1 # KBS Classic FM
	nano ~/kbs2fm
		#!/bin/sh
		(taskset -c 3) mplayer http://juoradio.appspot.com/kbs2 # KBS2 FM
	nano ~/cbsfm
		#!/bin/sh
		(taskset -c 3) mplayer rtmp://aac.cbs.co.kr/cbs939/_definst_/cbs939.stream # CBS Music FM
	chmod +x ~/kbs1fm ~/kbs2fm ~/cbsfm
	sudo ln -s /home/pi/kbs1fm /home/pi/kbs2fm /home/pi/cbsfm /usr/bin/
	kbs1fm
	kbs2fm
	cbsfm

19. Remove bash history

	rm ~/.bash_history
	
20. Make Image

	$ sudo fdisk -l
	$ sudo dd bs=4M (count=500) if=/dev/sdb of=raspbian_media_renderer_basic_v.0.9.0.img
	$ zip raspbian_media_renderer_basic_v.0.9.0.zip raspbian_media_renderer_basic_v.0.9.0.img
	
	https://drive.google.com/file/d/0B33LiMpVXH_FalhZaTVjVnNfU0k/view?usp=sharing

21. Documentation

	https://github.com/raspberrypi/documentation
